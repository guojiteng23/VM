# Virtual Machine for [[Vector Machine]]


## Motivation

在实际开发中，不同的计算机平台和操作系统对于指令集和硬件支持都存在差异，这使得同样一段程序在不同平台上的执行结果可能是不同的。为了克服这种差异，可以使用虚拟机来执行程序。虚拟机是一个软件程序，它提供了一个模拟的计算环境，可以在不同的操作系统和平台上运行，从而保证程序的可移植性。
此外，虚拟机还可以提高程序的安全性。由于虚拟机提供了一个封闭的执行环境，可以确保程序不会直接访问操作系统或其他进程的资源，从而避免了许多安全漏洞。
对于使用中间代码IR的场景，虚拟机可以直接执行这些中间代码，无需经过翻译器或编译器进行编译，这可以在开发过程中节省时间和资源。
因此，构建一个虚拟机的动机主要是为了提高程序的可移植性和安全性，并且在使用中间代码IR的情况下，可以直接执行程序，提高开发效率。

## Objective

构建一个虚拟机，支持以下特性：

    1.使用标量寄存器(gpr)和向量寄存器(vecr)。标量寄存器用于存储一个普通数据类型的值，向量寄存器则用于存储一组数据类型相同的值，以实现向量化计算。

    2.支持标量与标量，标量与向量，向量与向量的运算。对于标量与标量的运算，直接在标量寄存器之间进行；对于标量与向量或向量与向量的运算，需要使用向量寄存器。向量寄存器中的每个元素都可以看作一个独立的标量数据，因此可以进行相应的运算操作。

    3.支持数据类型：s8, s16, s32, u8, u16, u32, f16, f32。这些数据类型是常见的整数和浮点数类型，可以满足大多数计算需求。

    4.支持运算类型：+-*/ &|～^ <<>> !。这些运算类型包括加、减、乘、除、按位或、按位与、按位异或、左移、右移和按位求反等常见运算类型，以满足不同的计算需求。

    5.支持Mask寄存器。Mask寄存器的作用是控制流，即控制程序是否执行特定的操作。Mask寄存器通常只有一个位，值为0或1。在进行条件判断时，可以通过改变Mask寄存器的值来来控制下一步程序的执行路径。

    6.支持向量化指令集
      向量化指令集可以进一步提高虚拟机程序的性能。向量化指令集可以在处理向量计算时提高程序的运算速度，从而提高程序的执行性能。
      在虚拟机中使用SIMD指令和向量寄存器来实现向量化计算。这种方式需要对虚拟机的指令集和寄存器进行改进，以支持向量化计算。
      通过以上的方式，可以进一步提高虚拟机程序的执行效率和性能，特别是在处理大量数据时，可以发挥出多线程和向量化指令集的优势。

## Feature

    1.标量寄存器(gpr)特性:
      (1).存储单个标量值，通常用于存储整数、浮点数等数据类型的值。
      (2).通常有固定的长度和位宽，我设置为32位。
      (3).可以用于实现常规的标量计算操作，例如加、减、乘、除、逻辑运算等。

    2.向量寄存器(vec)特性:
      (1).存储多个数据元素，通常用于存储某种类型的向量数据。
      (2).通常有固定的长度和位宽，我设置为32位。
      (3).可以用于实现向量计算操作，例如向量加、向量乘等。
      (4).向量寄存器支持SIMD (Single Instruction Multiple Data)指令集，即可以一次性对多个数据元素进行操作，从而提高计算速度。
      (5).向量寄存器支持cambricon架构的指令和编程模型。

    3.Mask寄存器特性:
      (1).存储当前条件的真值或假值，通常只有一位值。
      (2).根据Mask寄存器的值决定下一步指令的执行路径，即控制流程。
      (3).通常与条件分支指令一起使用，例如，当执行条件分支指令时，Mask寄存器的值会根据条件的真值或假值而发生变化。
      (4).Mask寄存器可以用于实现控制流的快速分支，从而提高程序的执行效率。
      (5).Mask寄存器通常与SIMD指令一起使用，用于实现向量计算的控制流，以便于更灵活的向量计算。

    4.四地址码指令格式:
      四地址码指令格式是将指令中的操作数全部使用寄存器来表示，每个指令中包含4个操作数寄存器，并且可以包含一个Mask寄存器。以下是四地址码指令的格式：
                                         操作码 目的操作数 源操作数1 源操作数2 Mask寄存器
      操作码：表示该指令执行的操作，例如加法、乘法、除法等。
      目的操作数：表示接收该操作结果的寄存器。
      源操作数1和源操作数2：表示参与该操作的两个操作数的寄存器。
      Mask寄存器：可选项，表示该指令的条件控制位，决定了该指令是否执行。

    下面以加法指令为例来详细解释：
        加法指令的四地址码格式为：
            ADD 目的寄存器 源操作数1 源操作数2 Mask寄存器

        ADD：代表加法操作。
        目的寄存器：表示接收加法结果的寄存器。
        源操作数1和源操作数2：分别表示加法中的两个操作数所在的寄存器。
        Mask寄存器：可选项，表示该指令的条件控制位。

        例如，对于一个加法指令 ADD R1, R2, R3, MASK，表示将寄存器R2和R3中的值相加，将结果存储到寄存器R1中，只有当Mask寄存器的值为真时才执行该加法操作。

    四地址码指令格式可以实现更灵活、更高效的计算操作，适用于处理大规模的计算任务。同时，在需要考虑控制流的指令操作中，可以使用Mask寄存器来实现更高效的控制流程。

## Detailed

    1.Instruction set:

      add.vec.s32 r0, r1, r2, m0;
      sub.vec.f16 r2, r1, r0, m1;

## RoadMap

    1.Phase 1 


    2.Phase 2



## Reference

    1.LLVM
    2. 
